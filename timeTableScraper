#!/bin/bash

python3 -c "
from urllib.request import urlopen
from html.parser import HTMLParser
import re

# Extract data from Time Table
html = urlopen('http://www.artsandscience.utoronto.ca/ofr/timetable/winter/csc.html')
htmlData = html.read()

# The regular expressions for all 6 fields
course = re.compile('^CSC\d{3}H1$')
section = re.compile('^[FS]{1}$')
lecture = re.compile('^([TL]){1}(0|2|1|5){1}[0152]{1}0{1}')
time = re.compile('^[MWTRF]{1,3}\d?[-]?\d?$|Cancel|TBA')
instructor = re.compile('^\w\.|Tba|Staff')
location = re.compile('^\w{2} \d{1,4}')



# Different cases for extracted data
class MyHTMLParser(HTMLParser):
    courseMemory = ''
    sectionMemory = ''
    typeMemory = ''
    timeMemory = ''
    locationMemory = ''
    switch = False
    fieldMemory = 0


    def handle_data(self, data):
    	if course.match(data):
	        if self.fieldMemory == 4:
	        	print('<tr><td></td><td></td><td>' + self.typeMemory +'</td><td>' + self.timeMemory+ '</td><td>'+self.locationMemory+'</td><td>'+data+'</td>')
	        self.switch = True
	        self.fieldMemory = 0
	        self.courseMemory = data
    	elif section.match(data) and self.switch:
	        print('<tr><td>', self.courseMemory, '</td><td>', data, '</td>\n')
	        self.sectionMemory = data
	        self.fieldMemory = 1
	        self.switch = False
    	elif lecture.match(data):
	        self.typeMemory = data
	        self.fieldMemory = 2
    	elif time.match(data):
	        self.timeMemory = data
	        self.fieldMemory = 3
	        if data == 'Cancel':
	        	print('<tr><td></td><td></td><td>' + self.typeMemory +'</td><td>' + data+ '</td><td></td><td></td>')
	        if self.typeMemory[0] == 'T':
	            print('<tr><td></td><td></td><td>' + self.typeMemory +'</td><td>' + data+ '</td><td></td><td></td>')
    	elif location.match(data):
	        self.locationMemory = data
	        self.fieldMemory = 4
    	elif instructor.match(data) or (self.fieldMemory == 4 and data == '&nbsp'):
	        print('<tr><td></td><td></td><td>' + self.typeMemory +'</td><td>' + self.timeMemory+ '</td><td>'+self.locationMemory+'</td><td>'+data+'</td>')
	        self.fieldMemory = 5

parser = MyHTMLParser(strict=False)

print('<table class=\"timeTable\">')
print('<tr>'
	+ '<td>Course</td>'
	+ '<td>Section</td>'
	+ '<td>Type</td>'
	+ '<td>Time</td>'
	+ '<td>Location</td>'
	+ '<td>Instructor</td>'
	+ '</tr><div><p>')
parser.feed(str(htmlData))
print('</p></div></table>')
" > res/timeTable